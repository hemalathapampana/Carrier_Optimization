# M2M Reports: Detailed Algorithmic Analysis

## Overview

M2M (Machine-to-Machine) Reports are generated in the **AltaworxSimCardCostOptimizerCleanup.cs** Lambda function, specifically in the `WriteM2MResults()` method at **lines 746-850**. These reports provide comprehensive analysis of IoT device optimization results.

---

## 1. Device Assignment Spreadsheets

### **What**: 
Device Assignment Spreadsheets show which specific SIM cards/devices are assigned to which rate plans after optimization, including original assignments vs. optimized assignments.

### **Why**: 
- **Transparency**: Shows exactly which devices moved to which rate plans
- **Validation**: Allows verification of optimization decisions
- **Implementation**: Provides actionable data for rate plan changes
- **Audit Trail**: Creates documentation for optimization decisions

### **How**: 
Generated by collecting device results from optimization queues and mapping them to rate pools, then exporting to Excel format.

### **Code Location**: `AltaworxSimCardCostOptimizerCleanup.cs:796-798`

### **Algorithm**:
```
ALGORITHM: Generate_M2M_Device_Assignment_Spreadsheet
INPUT: queueIds, billingPeriod, optimizationResultRatePools
OUTPUT: Excel spreadsheet with device assignments

STEP 1: Initialize Assignment Collection
    assignmentFileBytes = null
    result = new M2MOptimizationResult()

STEP 2: Process Each Queue
    FOR each queueId in queueIds:
        deviceResults = GetM2MResults(context, [queueId], billingPeriod)
        result = BuildM2MOptimizationResult(deviceResults, optimizationResultRatePools, result)

STEP 3: Generate Assignment File
    assignmentFileBytes = RatePoolAssignmentWriter.WriteRatePoolAssignments(result)

STEP 4: Create Excel Spreadsheet
    assignmentXlsxBytes = RatePoolAssignmentWriter.GenerateExcelFileFromByteArrays(
        statFileBytes, 
        assignmentFileBytes, 
        sharedPoolStatFileBytes, 
        sharedPoolAssignmentFileBytes
    )

RETURN assignmentXlsxBytes
```

### **Data Retrieval Algorithm**:
**Location**: `AltaworxSimCardCostOptimizerCleanup.cs:833-893`

```
ALGORITHM: GetM2MResults_For_Device_Assignments
INPUT: context, queueIds, billingPeriod
OUTPUT: List<SimCardResult> with device assignment data

STEP 1: Validate Input
    IF queueIds.Count == 0:
        LOG warning "No queue Id to process"
        RETURN empty list

STEP 2: Execute Database Query
    QUERY: SELECT device.[Id] AS DeviceId, 
               [UsageMB], device.[ICCID], device.[MSISDN],
               ISNULL(commPlan.[AliasName], device.[CommunicationPlan]) AS CommunicationPlan, 
               ISNULL(carrierPlan.[RatePlanCode], customerPlan.[RatePlanCode]) AS RatePlanCode, 
               ISNULL(deviceResult.[AssignedCustomerRatePlanId], deviceResult.[AssignedCarrierRatePlanId]) AS RatePlanId, 
               deviceResult.[CustomerRatePoolId] AS RatePoolId,
               customerPool.[Name] AS RatePoolName,
               [ChargeAmt], device.[ProviderDateActivated], [SmsUsage], 
               [SmsChargeAmount], deviceResult.[BaseRateAmt], deviceResult.[RateChargeAmt], deviceResult.[OverageChargeAmt] 
           FROM OptimizationDeviceResult deviceResult 
           INNER JOIN Device device ON deviceResult.[AmopDeviceId] = device.[Id] 
           LEFT JOIN JasperCommunicationPlan commPlan ON commPlan.[CommunicationPlanName] = device.[CommunicationPlan] 
           LEFT JOIN JasperCarrierRatePlan carrierPlan ON deviceResult.[AssignedCarrierRatePlanId] = carrierPlan.[Id] 
           LEFT JOIN JasperCustomerRatePlan customerPlan ON deviceResult.[AssignedCustomerRatePlanId] = customerPlan.[Id] 
           LEFT JOIN CustomerRatePool customerPool ON deviceResult.[CustomerRatePoolId] = customerPool.[Id] 
           WHERE deviceResult.[QueueId] IN (@QueueIds)

STEP 3: Process Query Results
    simCards = empty list
    WHILE reader.Read():
        simCard = SimCardResultFromReader(reader, billingPeriod)
        simCards.Add(simCard)

STEP 4: Calculate Billing Period Data
    FOR each simCard in simCards:
        simCard.WasActivatedInThisBillingPeriod = DateIsInBillingPeriod(simCard.DateActivated, billingPeriod)
        simCard.DaysActivatedInBillingPeriod = Calculate days active in billing period

RETURN simCards
```

---

## 2. Cost Savings Summaries

### **What**: 
Cost Savings Summaries calculate and display the financial impact of optimization, showing before/after costs and total savings achieved.

### **Why**: 
- **ROI Demonstration**: Proves value of optimization process
- **Financial Reporting**: Provides data for financial analysis
- **Decision Making**: Helps evaluate optimization effectiveness
- **Stakeholder Communication**: Clear savings metrics for management

### **How**: 
Calculated by comparing original rate plan costs with optimized rate plan costs across all devices.

### **Code Location**: `AltaworxSimCardCostOptimizerCleanup.cs:788-790`

### **Algorithm**:
```
ALGORITHM: Generate_M2M_Cost_Savings_Summary
INPUT: result (M2MOptimizationResult), billingPeriod
OUTPUT: Statistical summary with cost savings data

STEP 1: Calculate Statistics
    statFileBytes = RatePoolStatisticsWriter.WriteRatePoolStatistics(
        SimCardGrouping.GroupByCommunicationPlan, 
        result
    )

STEP 2: Build Cost Analysis
    FOR each RatePoolCollection in result.RawRatePools:
        totalOriginalCost = 0
        totalOptimizedCost = 0
        
        FOR each RatePool in collection.RatePools:
            FOR each SimCard in ratePool.SimCards:
                totalOriginalCost += SimCard.OriginalCost
                totalOptimizedCost += SimCard.OptimizedCost
        
        totalSavings = totalOriginalCost - totalOptimizedCost
        savingsPercentage = (totalSavings / totalOriginalCost) * 100

STEP 3: Generate Summary Report
    summary = {
        TotalDevices: result.TotalDeviceCount,
        OriginalCost: totalOriginalCost,
        OptimizedCost: totalOptimizedCost,
        TotalSavings: totalSavings,
        SavingsPercentage: savingsPercentage,
        BillingPeriod: billingPeriod
    }

RETURN statFileBytes (containing summary)
```

### **Cost Calculation Algorithm**:
**Location**: Embedded in `BuildM2MOptimizationResult()` method

```
ALGORITHM: Calculate_Device_Costs
INPUT: deviceResults, ratePools
OUTPUT: Cost calculations for each device

FOR each deviceResult in deviceResults:
    STEP 1: Get Original Cost
    originalCost = deviceResult.BaseRateAmt + deviceResult.OverageChargeAmt

    STEP 2: Calculate Optimized Cost
    assignedRatePool = Find rate pool where deviceResult.RatePlanId matches
    optimizedCost = Calculate cost in assigned rate pool based on usage

    STEP 3: Calculate Savings
    savingsAmount = originalCost - optimizedCost
    savingsPercentage = (savingsAmount / originalCost) * 100

    STEP 4: Store Results
    deviceResult.OriginalCost = originalCost
    deviceResult.OptimizedCost = optimizedCost
    deviceResult.Savings = savingsAmount
```

---

## 3. Rate Plan Utilization Statistics

### **What**: 
Rate Plan Utilization Statistics show how effectively each rate plan is being used, including usage patterns, capacity utilization, and efficiency metrics.

### **Why**: 
- **Optimization Validation**: Confirms rate plans are used efficiently
- **Capacity Planning**: Shows which plans are over/under utilized
- **Plan Effectiveness**: Identifies best-performing rate plans
- **Future Planning**: Data for rate plan strategy decisions

### **How**: 
Calculated by analyzing device usage patterns against rate plan capacities and costs.

### **Code Location**: `AltaworxSimCardCostOptimizerCleanup.cs:1376-1390`

### **Algorithm**:
```
ALGORITHM: Generate_Rate_Plan_Utilization_Statistics
INPUT: deviceResults, ratePools, billingPeriod
OUTPUT: Utilization statistics for each rate plan

STEP 1: Initialize Utilization Tracking
    utilizationStats = new Dictionary<RatePlanId, UtilizationMetrics>()

STEP 2: Process Each Rate Pool
    FOR each ratePool in ratePools:
        metrics = new UtilizationMetrics()
        
        STEP 2a: Calculate Basic Metrics
        metrics.TotalDevices = ratePool.SimCards.Count
        metrics.TotalUsage = SUM(simCard.CycleDataUsageMB for simCard in ratePool.SimCards)
        metrics.PlanCapacity = ratePool.RatePlan.DataAllowanceMB
        
        STEP 2b: Calculate Utilization Percentage
        IF metrics.PlanCapacity > 0:
            metrics.UtilizationPercentage = (metrics.TotalUsage / metrics.PlanCapacity) * 100
        ELSE:
            metrics.UtilizationPercentage = 0
        
        STEP 2c: Calculate Efficiency Metrics
        metrics.AverageUsagePerDevice = metrics.TotalUsage / metrics.TotalDevices
        metrics.UnderutilizedDevices = COUNT devices with usage < (PlanCapacity * 0.3)
        metrics.OverutilizedDevices = COUNT devices with usage > PlanCapacity
        
        STEP 2d: Calculate Cost Efficiency
        metrics.CostPerMB = ratePool.RatePlan.MonthlyRate / ratePool.RatePlan.DataAllowanceMB
        metrics.EffectiveCostPerMB = (Total charges for pool) / metrics.TotalUsage
        
        utilizationStats[ratePool.RatePlan.Id] = metrics

STEP 3: Generate Utilization Report
    FOR each ratePlan, metrics in utilizationStats:
        utilizationReport.Add({
            RatePlanCode: ratePlan.Code,
            DeviceCount: metrics.TotalDevices,
            TotalUsageMB: metrics.TotalUsage,
            UtilizationPercentage: metrics.UtilizationPercentage,
            AverageUsage: metrics.AverageUsagePerDevice,
            Efficiency: CalculateEfficiencyScore(metrics),
            Recommendation: GenerateRecommendation(metrics)
        })

RETURN utilizationReport
```

### **Efficiency Calculation Algorithm**:
```
ALGORITHM: Calculate_Rate_Plan_Efficiency
INPUT: utilizationMetrics
OUTPUT: Efficiency score (0-100)

STEP 1: Calculate Base Efficiency
    IF utilizationPercentage BETWEEN 70 AND 95:
        baseEfficiency = 100
    ELSE IF utilizationPercentage < 70:
        baseEfficiency = utilizationPercentage / 70 * 100
    ELSE: // > 95%
        overage = utilizationPercentage - 95
        baseEfficiency = 100 - (overage * 2) // Penalty for overages

STEP 2: Apply Device Distribution Penalty
    deviceVariance = CalculateUsageVariance(devices)
    IF deviceVariance > threshold:
        baseEfficiency *= 0.9 // 10% penalty for high variance

STEP 3: Apply Cost Efficiency Factor
    costEfficiencyRatio = StandardCostPerMB / EffectiveCostPerMB
    efficiencyScore = baseEfficiency * costEfficiencyRatio

RETURN MIN(efficiencyScore, 100)
```

---

## 4. Optimization Group Details

### **What**: 
Optimization Group Details provide information about how devices are grouped for optimization, including group composition, performance, and recommendations.

### **Why**: 
- **Group Performance**: Shows how well each optimization group performs
- **Rebalancing Insights**: Identifies groups that need adjustment
- **Strategy Validation**: Confirms grouping strategy effectiveness
- **Operational Planning**: Data for group management decisions

### **How**: 
Analyzed by grouping devices by communication plans or customer-defined groups and calculating group-level metrics.

### **Code Location**: `AltaworxSimCardCostOptimizerCleanup.cs:1150-1189`

### **Algorithm**:
```
ALGORITHM: Generate_Optimization_Group_Details
INPUT: instance, queueIds, billingPeriod, isCustomerOptimization
OUTPUT: Detailed analysis of optimization groups

STEP 1: Get Rate Pool Collections
    ratePlans = GetRatePlansByPortalType(context, instance, isCustomerOptimization, billingPeriod.Id)
    planPoolMappings = GetRatePlanToRatePoolMappingByPortalType(context, queueIds, instance.PortalType)

STEP 2: Build Group Structure
    ratePools = GenerateResultRatePoolFromRatePlans(billingPeriod, usesProration, ratePlans, planPoolMappings, false, instance)
    
    IF isCustomerOptimization:
        crossPooledPlans = GetCrossCustomerRatePlans(context, distinct ratePlanIds from mappings)
        crossPooledPlans = Filter out duplicate plans
        IF crossPooledPlans.Count > 0:
            ratePools.AddRange(GenerateResultRatePoolFromRatePlans(..., crossPooledPlans, ..., true, instance))

STEP 3: Analyze Each Group
    groupDetails = new List<OptimizationGroupDetail>()
    
    FOR each ratePool in ratePools:
        groupDetail = new OptimizationGroupDetail()
        
        STEP 3a: Basic Group Information
        groupDetail.GroupId = ratePool.GroupIdentifier
        groupDetail.GroupName = ratePool.RatePoolName
        groupDetail.GroupType = ratePool.IsSharedRatePool ? "Cross-Customer" : "Customer-Specific"
        groupDetail.DeviceCount = ratePool.SimCards.Count
        
        STEP 3b: Usage Analysis
        groupDetail.TotalUsage = SUM(simCard.CycleDataUsageMB for simCard in ratePool.SimCards)
        groupDetail.AverageUsage = groupDetail.TotalUsage / groupDetail.DeviceCount
        groupDetail.UsageVariance = CalculateUsageVariance(ratePool.SimCards)
        
        STEP 3c: Cost Analysis
        groupDetail.TotalOriginalCost = SUM(simCard.OriginalCost for simCard in ratePool.SimCards)
        groupDetail.TotalOptimizedCost = SUM(simCard.OptimizedCost for simCard in ratePool.SimCards)
        groupDetail.TotalSavings = groupDetail.TotalOriginalCost - groupDetail.TotalOptimizedCost
        groupDetail.SavingsPercentage = (groupDetail.TotalSavings / groupDetail.TotalOriginalCost) * 100
        
        STEP 3d: Performance Metrics
        groupDetail.OptimizationEffectiveness = CalculateOptimizationEffectiveness(ratePool)
        groupDetail.GroupCohesion = CalculateGroupCohesion(ratePool.SimCards)
        groupDetail.RecommendedActions = GenerateGroupRecommendations(groupDetail)
        
        groupDetails.Add(groupDetail)

STEP 4: Generate Group Summary
    overallSummary = {
        TotalGroups: groupDetails.Count,
        TotalDevices: SUM(group.DeviceCount for group in groupDetails),
        BestPerformingGroup: groupDetails.OrderByDescending(g => g.SavingsPercentage).First(),
        RecommendedRebalancing: IdentifyRebalancingOpportunities(groupDetails)
    }

RETURN {groupDetails, overallSummary}
```

### **Group Performance Calculation Algorithm**:
```
ALGORITHM: Calculate_Group_Performance_Metrics
INPUT: ratePool (with SimCards)
OUTPUT: Performance metrics for the group

STEP 1: Calculate Usage Cohesion
    usages = [simCard.CycleDataUsageMB for simCard in ratePool.SimCards]
    mean = AVERAGE(usages)
    variance = AVERAGE((usage - mean)² for usage in usages)
    coefficientOfVariation = SQRT(variance) / mean
    usageCohesion = MAX(0, 100 - (coefficientOfVariation * 100))

STEP 2: Calculate Cost Effectiveness
    avgSavingsPerDevice = ratePool.TotalSavings / ratePool.DeviceCount
    industryBenchmark = GetIndustryBenchmarkSavings()
    costEffectiveness = (avgSavingsPerDevice / industryBenchmark) * 100

STEP 3: Calculate Optimization Score
    utilizationScore = CalculateUtilizationScore(ratePool)
    savingsScore = (ratePool.SavingsPercentage / 30) * 100 // Normalize against 30% target
    optimizationScore = (utilizationScore * 0.4) + (savingsScore * 0.6)

STEP 4: Generate Recommendations
    recommendations = []
    
    IF usageCohesion < 70:
        recommendations.Add("Consider splitting group - high usage variance detected")
    
    IF costEffectiveness < 80:
        recommendations.Add("Review rate plan selection for this group")
    
    IF utilizationScore < 60:
        recommendations.Add("Group may benefit from different rate plan strategy")

RETURN {
    UsageCohesion: usageCohesion,
    CostEffectiveness: costEffectiveness,
    OptimizationScore: optimizationScore,
    Recommendations: recommendations
}
```

---

## Data Flow Summary

### **Complete M2M Report Generation Flow**:
```
ALGORITHM: Complete_M2M_Report_Generation_Flow
INPUT: context, instance, queueIds, billingPeriod, usesProration, isCustomerOptimization
OUTPUT: Complete M2M optimization report (Excel file)

STEP 1: Initialize [Lines 749-754]
    result = new M2MOptimizationResult()
    crossCustomerResult = new M2MOptimizationResult()

STEP 2: Get Rate Pools [Lines 755-760]
    crossOptimizationResultRatePools = GetResultRatePools(...)
    optimizationResultRatePools = GenerateCustomerSpecificRatePools(...)
    AddUnassignedRatePool(...) // If customer optimization

STEP 3: Process All Queues [Lines 761-777]
    shouldShowCrossPoolingTab = false
    FOR each queueId in queueIds:
        // Device Assignments
        deviceResults = GetM2MResults(context, [queueId], billingPeriod)
        result = BuildM2MOptimizationResult(deviceResults, optimizationResultRatePools, result)
        
        // Shared Pool Analysis
        sharedPoolDeviceResults = GetM2MSharedPoolResults(context, [queueId], billingPeriod)
        IF sharedPoolDeviceResults.Count > 0:
            shouldShowCrossPoolingTab = true
        sharedPoolDeviceResults.AddRange(deviceResults)
        crossCustomerResult = BuildM2MOptimizationResult(sharedPoolDeviceResults, crossOptimizationResultRatePools, crossCustomerResult, true)

STEP 4: Generate All Report Components [Lines 779-797]
    // Cost Savings & Rate Plan Utilization
    statFileBytes = RatePoolStatisticsWriter.WriteRatePoolStatistics(SimCardGrouping.GroupByCommunicationPlan, result)
    
    // Device Assignments
    assignmentFileBytes = RatePoolAssignmentWriter.WriteRatePoolAssignments(result)
    
    // Shared Pool Reports (if applicable)
    IF shouldShowCrossPoolingTab:
        sharedPoolStatFileBytes = RatePoolStatisticsWriter.WriteRatePoolStatistics(SimCardGrouping.GroupByCommunicationPlan, crossCustomerResult)
        sharedPoolAssignmentFileBytes = RatePoolAssignmentWriter.WriteRatePoolAssignments(crossCustomerResult)

STEP 5: Create Final Excel File [Lines 798-800]
    assignmentXlsxBytes = RatePoolAssignmentWriter.GenerateExcelFileFromByteArrays(
        statFileBytes, 
        assignmentFileBytes, 
        sharedPoolStatFileBytes, 
        sharedPoolAssignmentFileBytes
    )

STEP 6: Save and Return [Lines 802-803]
    RETURN SaveOptimizationInstanceResultFile(context, instance.Id, assignmentXlsxBytes)
```

This comprehensive algorithmic breakdown provides clear, step-by-step understanding of how each M2M report component is generated, with specific code locations in the Lambda function.